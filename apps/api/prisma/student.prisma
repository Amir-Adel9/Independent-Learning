model Student {
  id String @id @default(uuid())

  // Laravel user id (string to be safe even if Laravel uses int)
  externalUserId String @unique

  // optional cached fields from /profile
  name  String?
  email String?

  lastSeenAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  interests      StudentInterest[]
  savedMaterials StudentSavedMaterial[]
  progress       StudentProgress[]
  recentViews    StudentRecentView[]
}

model StudentInterest {
  studentId String
  topicId   String
  createdAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  topic   Topic   @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@id([studentId, topicId])
  @@index([topicId])
}

model StudentSavedMaterial {
  studentId  String
  materialId String
  createdAt  DateTime @default(now())

  student  Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  material LearningMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@id([studentId, materialId])
  @@index([materialId])
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model StudentProgress {
  studentId  String
  materialId String

  status ProgressStatus @default(NOT_STARTED)

  // 0..100 for generic progress (videos/articles)
  progressPct Int @default(0)

  // for videos (resume + completion rule)
  lastPositionSec Int?

  completedAt DateTime?
  updatedAt   DateTime  @updatedAt
  createdAt   DateTime  @default(now())

  student  Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  material LearningMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@id([studentId, materialId])
  @@index([materialId])
  @@index([status])
}

model StudentRecentView {
  studentId    String
  materialId   String
  lastViewedAt DateTime @default(now())

  student  Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  material LearningMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@id([studentId, materialId])
  @@index([studentId, lastViewedAt])
  @@index([materialId])
}
